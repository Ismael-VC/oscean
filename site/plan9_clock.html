<!DOCTYPE html><html><head><link href="../links/main.css" type="text/css" rel="stylesheet"/><link href="../media/services/icon.png" type="image/png" rel="shortcut icon"/><title>XXIIVV &mdash; plan9 clock</title></head><body><header><a href="home.html"><img src="../media/icon/logo.svg" alt="XXIIVV"/></a></header><nav><ul><li><a href="../site/plan9.html">plan9</a></li><li><a href="../site/linux.html">linux</a></li></ul><ul><li><a href="../site/rio.html">rio</a></li><li><a href="../site/acme.html">acme</a></li><li><a href="../site/plan9_c.html">plan9 c</a></li><li>plan9 clock/</li><li><a href="../site/plan9_color.html">plan9 color</a></li></ul><ul></ul></nav><main><figure><img src="../media/diary/723.jpg" alt="Not into babyblue"/><figcaption>Not into babyblue</figcaption></figure><h2>Updated the look of the Plan9 clock.</h2>

<p>I wasn't <i>really</i> into the whole baby blue clock, also in it not displaying seconds, so I've fixed it up a bit. It now displays each second on the clockface, and use hairline thin lines drawn through the Bresenham algorithm. The style is designed to align with the <a href='plan9_color.html'>Plan9 Color Picker</a>. This project is a good simple demonstration of <a href='plan9_c.html'>Plan9 C</a>.</p>
<h3>Installation</h3>
<p>Compile this source with the compiler for your platform, if you are using an ARM device:</p>
<pre>5c clock.c && 5l -o clock clock.c</pre>
<p>If you want to install globally, copy the source into <code>/sys/src/cmd/clock.c</code> and type <code>mk install</code> inside of <code>/sys/src/cmd</code>, to recompile all the applications found in the cmd directory.</p>
<pre>#include &lt;u.h&gt;<br />#include &lt;libc.h&gt;<br />#include &lt;draw.h&gt;<br />#include &lt;event.h&gt;<br /><br />Point<br />circlept(Point c, int r, int degrees)<br />{<br />	double rad = (double)degrees * PI / 180.0;<br /><br />	c.x += cos(rad) * r;<br />	c.y -= sin(rad) * r;<br />	return c;<br />}<br /><br />void<br />lineb(Image* dst, Point p0, Point p1, Image* src, Point sp)<br />{<br />	int dx = abs(p1.x - p0.x), sx = p0.x &lt; p1.x ? 1 : -1;<br />	int dy = -abs(p1.y - p0.y), sy = p0.y &lt; p1.y ? 1 : -1;<br />	int err = dx + dy, e2;<br /><br />	for(;;) {<br />		draw(dst, Rect(p0.x, p0.y, p0.x + 1, p0.y + 1), src, nil, ZP);<br />		if(p0.x == p1.x &amp;&amp; p0.y == p1.y)<br />			break;<br />		e2 = 2 * err;<br />		if(e2 &gt;= dy) {<br />			err += dy;<br />			p0.x += sx;<br />		}<br />		if(e2 &lt;= dx) {<br />			err += dx;<br />			p0.y += sy;<br />		}<br />	}<br />}<br /><br />void<br />redraw(Image* dst)<br />{<br />	Point size = subpt(screen-&gt;r.max, screen-&gt;r.min);<br />	Point center = divpt(size, 2);<br />	Rectangle frame = (Rectangle){Pt(0, 0), size};<br />	int pad = 20;<br />	int rad = ((size.x &lt; size.y ? size.x : size.y) / 2) - pad;<br />	int range = rad - pad;<br />	Image* view = allocimage(display, frame, screen-&gt;chan, 1, 0x000000FF);<br />	Image* secclr = allocimagemix(display, DRed, DRed);<br /><br />	for(int i = 0; i &lt; 60; i++) {<br />		int len = i % 15 == 0 ? range : i % 5 == 0 ? rad - pad / 2 : rad - pad / 3;<br />		lineb(view, circlept(center, len, i * 6), circlept(center, rad, i * 6), display-&gt;white, ZP);<br />	}<br /><br />	Tm tms = *localtime(time(0));<br />	int anghr = 90 - (tms.hour * 5 + tms.min / 12) * 6;<br />	int angmin = 90 - tms.min * 6;<br />	int angsec = 90 - tms.sec * 6;<br />	int angsecrev = 270 - tms.sec * 6;<br /><br />	fillellipse(view, center, rad - pad, rad - pad, display-&gt;black, ZP);<br />	lineb(view, center, circlept(center, range * 0.7, anghr), display-&gt;white, ZP);<br />	lineb(view, center, circlept(center, range - 2, angmin), display-&gt;white, ZP);<br />	lineb(view, center, circlept(center, range - 2, angsec), secclr, ZP);<br />	lineb(view, center, circlept(center, range * 0.1, angsecrev), secclr, ZP);<br />	fillellipse(view, center, 2, 2, secclr, ZP);<br /><br />	/* collapse when horizontal window */<br />	if(size.y &gt; size.x + 2 * pad) {<br />		/* time */<br />		char timestr[9];<br />		snprint(timestr, sizeof(timestr), "%02d:%02d:%02d", tms.hour, tms.min, tms.sec);<br />		Point timesize = stringsize(display-&gt;defaultfont, timestr);<br />		Point timept = Pt(pad, pad);<br />		/* date */<br />		char datestr[30];<br />		snprint(datestr, sizeof(datestr), "%s", ctime(time(0)));<br />		datestr[10] = '\0';<br />		Point datesize = stringsize(display-&gt;defaultfont, datestr);<br />		Point datept = Pt(size.x - datesize.x - pad, pad);<br />		/* draw */<br />		draw(view,<br />		     (Rectangle){timept, addpt(timept, Pt(size.x - pad * 2, 0))},<br />		     display-&gt;black, nil, ZP);<br />		string(view, timept, display-&gt;white, ZP, display-&gt;defaultfont, timestr);<br />		if(timesize.x + datesize.x &lt; size.x - pad - pad)<br />			string(view, datept, display-&gt;white, ZP, display-&gt;defaultfont, datestr);<br />	}<br /><br />	draw(dst, screen-&gt;r, view, nil, ZP);<br />	flushimage(display, 1);<br />	freeimage(secclr);<br />	freeimage(view);<br />}<br /><br />void<br />eresized(int new)<br />{<br />	if(new&amp;&amp; getwindow(display, Refnone) &lt; 0)<br />		fprint(2, "can't reattach to window");<br />	redraw(screen);<br />}<br /><br />void<br />main(int argc, char* argv[])<br />{<br />	USED(argc, argv);<br />	<br />	Event e;<br />	Mouse m;<br />	Menu menu;<br />	char* mstr[] = {"exit", 0};<br />	int key, timer, t = 1000;<br /><br />	if(initdraw(0, 0, "clock") &lt; 0)<br />		sysfatal("initdraw failed");<br /><br />	eresized(0);<br />	einit(Emouse);<br />	timer = etimer(0, t);<br />	menu.item = mstr;<br />	menu.lasthit = 0;<br /><br />	for(;;) {<br />		key = event(&amp;e);<br />		if(key == Emouse) {<br />			m = e.mouse;<br />			if(m.buttons &amp; 4) {<br />				if(emenuhit(3, &amp;m, &amp;menu) == 0)<br />					exits(0);<br />			}<br />		} else if(key == timer) {<br />			redraw(screen);<br />		}<br />	}<br />}</pre>

<ul></ul></main><footer><a href="https://creativecommons.org/licenses/by-nc-sa/4.0" target="_blank"><img src="../media/icon/cc.svg" alt="CreativeCommons"/></a><a href="http://webring.xxiivv.com/" target="_blank"><img src="../media/icon/webring.svg" alt="Webring"/></a><a href="https://merveilles.town/@neauoire" target="_blank"><img src="../media/icon/merveilles.svg" alt="Merveilles"/></a><span><a href="devine_lu_linvega.html">Devine Lu Linvega</a> &copy; 2021 &mdash; <a href="about.html">BY-NC-SA 4.0</a></span></footer></body></html>