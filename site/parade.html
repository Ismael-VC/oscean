<!DOCTYPE html><html lang='en'><head><meta charset='utf-8'><meta name='description' content='Parade is a minimal implementation of Paradise.'/><meta name='thumbnail' content='https://wiki.xxiivv.com/media/services/thumbnail.jpg' /><meta name='viewport' content='width=device-width,initial-scale=1'><link rel='alternate' type='application/rss+xml' title='RSS Feed' href='../links/rss.xml' /><link rel='stylesheet' type='text/css' href='../links/main.css'><link rel='shortcut icon' type='image/png' href='../media/services/icon.png'><title>XXIIVV &mdash; parade</title><meta property='og:title' content='XXIIVV &mdash; parade'><meta property='og:description' content='Parade is a minimal implementation of Paradise.'><meta property='og:url' content='https://wiki.xxiivv.com/site/parade.html'><meta property='og:type' content='website' /><meta property='og:image' content='https://wiki.xxiivv.com/media/services/rss.jpg'></head><body><header><a href='home.html'><img src='../media/icon/logo.svg' alt='XXIIVV' height='29'></a></header><nav><ul><li><a href='paradise.html'>paradise/</a></li><li><a href='bifurcan.html'>bifurcan</a></li><li><a href='spacetime_6502.html'>spacetime 6502</a></li><li><a href='nespaint.html'>nespaint</a></li></ul><ul><li><a href='maeve.html'>maeve</a></li><li><a href='parade.html'>parade/</a></li></ul><ul></ul></nav><main><h2>Parade is a minimal implementation of Paradise.</h2><p>In <b>Paradise</b>, you are but a force acting upon places, objects, words — vessels. Parade is a subset of the <a href='paradise.html'>Paradise</a> interactive fiction engine designed explicitly to explore the possible interactions available within the primitives. </p><q>I have always imagined that <b>Paradise</b> will be a kind of library.</q><h5>—Jorge Luis Borges</h5><figure><pre>#include &lt;stdio.h&gt;<br /><br />#define NAMELEN 16<br />#define TEXTLEN 256<br />#define BUFLEN 512<br /><br />typedef struct Vessel {<br />	char id, name[NAMELEN], note[TEXTLEN], prog[TEXTLEN];<br />	struct Vessel *owner, *parent;<br />} Vessel;<br /><br />typedef struct Parade {<br />	int len;<br />	Vessel vessels[256];<br />} Parade;<br /><br />Vessel *guest;<br /><br />/* clang-format off */<br /><br />static char *actions[12] = {<br />	"create", "become",  "enter", "leave", <br />	"take",   "drop",    "warp",  "transform", <br />	"note",   "program", "use",   ""};<br /><br />#pragma mark - Helpers<br /><br />static unsigned char chex(char c) { if(c &gt;= 'a' &amp;&amp; c &lt;= 'f') return 10 + c - 'a'; if(c &gt;= 'A' &amp;&amp; c &lt;= 'F') return 10 + c - 'A'; return (c - '0') &amp; 0xF; }<br />static unsigned char shex(char *s, int len) { int i, n = 0; for(i = 0; i &lt; len; ++i) n |= (chex(s[i]) &lt;&lt; ((len - i - 1) * 4)); return n; }<br />static int    imin(int a, int b) { return a &lt; b ? a : b; }<br />static int    cisp(char c) { return c == ' ' || c == '\t' || c == '\n' || c == '\r'; }<br />static int    slen(char *s) { int n = 0; while(s[n] &amp;&amp; s[++n]) ; return n; }<br />static int    cpos(char *s, char c) { int i = 0; while(s[i] &amp;&amp; s[i]) if(s[i++] == c) return i - 1; return -1; }<br />static char * spor(char *s, int c) { int i; for(i = slen(s); i &gt;= 0; --i) if(s[i] == c) return s + i; return s - 1; }<br />static int    scmp(char *a, char *b) { int i = 0; while(a[i] == b[i]) if(!a[i++]) return 1; return 0; }<br />static char * strm(char *s) { char *end; while(cisp(*s)) s++; if(*s == 0) return s; end = s + slen(s) - 1; while(end &gt; s &amp;&amp; cisp(*end)) end--; end[1] = '\0'; return s; }<br />static int    afnd(char *src[], int len, char *val) { int i; for(i = 0; i &lt; len; i++) if(scmp(src[i], val)) return i; return -1; }<br />static char * sstr(char *src, char *dest, int from, int to) { int i; char *a = (char *)src + from, *b = (char *)dest; for(i = 0; i &lt; to; i++) b[i] = a[i]; dest[to] = '\0'; return dest; }<br /><br />/* clang-format on */<br /><br />#pragma mark - Generics<br /><br />static int<br />isvisible(Vessel *g, Vessel *v)<br />{<br />	if(g-&gt;parent != v-&gt;parent)<br />		return 0;<br />	if(g-&gt;parent == v)<br />		return 0;<br />	if(g == v)<br />		return 0;<br />	return 1;<br />}<br /><br />static int<br />isparadox(Vessel *v)<br />{<br />	return v-&gt;parent == v;<br />}<br /><br />static char<br />rune(Vessel *v)<br />{<br />	if(isparadox(v))<br />		return '^';<br />	if(slen(v-&gt;note) &gt; 0)<br />		return '*';<br />	if(slen(v-&gt;prog) &gt; 0)<br />		return '+';<br />	if(v-&gt;owner == guest)<br />		return '~';<br />	return 0;<br />}<br /><br />static Vessel *<br />addvessel(Parade *p, Vessel *v, char *name)<br />{<br />	Vessel *nv = &amp;p-&gt;vessels[p-&gt;len];<br />	nv-&gt;id = p-&gt;len;<br />	nv-&gt;owner = v ? v : nv;<br />	nv-&gt;parent = v ? v-&gt;parent : nv;<br />	sstr(name, nv-&gt;name, 0, imin(slen(name), NAMELEN - 1));<br />	p-&gt;len++;<br />	return nv;<br />}<br /><br />static Vessel *<br />findvisible(Parade *p, Vessel *v, char *name)<br />{<br />	int i;<br />	char *n = spor(name, ' ') + 1;<br />	for(i = 0; i &lt; p-&gt;len; ++i) {<br />		if(!isvisible(v, &amp;p-&gt;vessels[i]))<br />			continue;<br />		if(scmp(p-&gt;vessels[i].name, n))<br />			return &amp;p-&gt;vessels[i];<br />	}<br />	return NULL;<br />}<br /><br />static Vessel *<br />findinventory(Parade *p, Vessel *v, char *name)<br />{<br />	int i;<br />	char *n = spor(name, ' ') + 1;<br />	for(i = 0; i &lt; p-&gt;len; ++i) {<br />		if(&amp;p-&gt;vessels[i] == v)<br />			continue;<br />		if(p-&gt;vessels[i].parent != v)<br />			continue;<br />		if(scmp(p-&gt;vessels[i].name, n))<br />			return &amp;p-&gt;vessels[i];<br />	}<br /><br />	return NULL;<br />}<br /><br />static Vessel *<br />findany(Parade *p, char *name)<br />{<br />	int i;<br />	char *n = spor(name, ' ') + 1;<br />	for(i = 0; i &lt; p-&gt;len; ++i)<br />		if(scmp(p-&gt;vessels[i].name, n))<br />			return &amp;p-&gt;vessels[i];<br />	return NULL;<br />}<br /><br />#pragma mark - Actions<br /><br />static void<br />createvessel(Parade *p, char *val)<br />{<br />	Vessel *v;<br />	if(findany(p, val) || slen(val) &lt; 4 || p-&gt;len &gt; 255)<br />		printf("You cannot create the %s.\n", val);<br />	else {<br />		v = addvessel(p, guest, spor(val, ' ') + 1);<br />		printf("You created the %s%c.\n", v-&gt;name, rune(v));<br />	}<br />}<br /><br />static void<br />becomevessel(Parade *p, char *val)<br />{<br />	Vessel *v = findany(p, val);<br />	if(!v)<br />		printf("You do not see the %s.\n", val);<br />	else {<br />		guest = v;<br />		printf("You became the %s%c.\n", v-&gt;name, rune(v));<br />	}<br />}<br /><br />static void<br />entervessel(Parade *p, char *val)<br />{<br />	Vessel *v = findvisible(p, guest, val);<br />	if(!v)<br />		printf("You do not see the %s.\n", val);<br />	else {<br />		guest-&gt;parent = v;<br />		printf("You entered the %s%c.\n", v-&gt;name, rune(v));<br />	}<br />}<br /><br />static void<br />leavevessel(void)<br />{<br />	Vessel *v = guest-&gt;parent;<br />	if(v == v-&gt;parent)<br />		printf("You cannot leave the %s%c.\n", v-&gt;name, rune(v));<br />	else {<br />		printf("You left the %s%c.\n", v-&gt;name, rune(v));<br />		guest-&gt;parent = v-&gt;parent;<br />	}<br />}<br /><br />static void<br />takevessel(Parade *p, char *val)<br />{<br />	Vessel *v = findvisible(p, guest, val);<br />	if(!v)<br />		printf("You do not see the %s.\n", val);<br />	else {<br />		v-&gt;parent = guest;<br />		printf("You took the %s%c.\n", v-&gt;name, rune(v));<br />	}<br />}<br /><br />static void<br />dropvessel(Parade *p, char *val)<br />{<br />	Vessel *v = findinventory(p, guest, val);<br />	if(!v)<br />		printf("You do not carry the %s.\n", val);<br />	else {<br />		v-&gt;parent = guest-&gt;parent-&gt;parent;<br />		printf("You dropped the %s%c.\n", v-&gt;name, rune(v));<br />	}<br />}<br /><br />static void<br />warpvessel(Parade *p, char *val)<br />{<br />	Vessel *v = findany(p, val);<br />	if(!v)<br />		printf("You cannot warp to the %s.\n", val);<br />	else {<br />		guest-&gt;parent = v;<br />		printf("You warped to the %s%c.\n", v-&gt;name, rune(v));<br />	}<br />}<br /><br />static void<br />transformvessel(Parade *p, char *val)<br />{<br />	char *name = spor(val, ' ') + 1;<br />	if(findany(p, name) || slen(name) &lt; 3)<br />		printf("You cannot transform into the %s.\n", name);<br />	else {<br />		sstr(name, guest-&gt;name, 0, imin(slen(name), TEXTLEN - 1));<br />		printf("You transformed into the %s%c.\n", guest-&gt;name, rune(guest));<br />	}<br />}<br /><br />static void<br />notevessel(char *val)<br />{<br />	Vessel *v = guest-&gt;parent;<br />	if(slen(val) &lt; 1)<br />		printf("You remove the note of the %s%c.\n", v-&gt;name, rune(v));<br />	else {<br />		sstr(val, v-&gt;note, 0, imin(slen(val), TEXTLEN - 1));<br />		printf("You added a note to the %s%c.\n", v-&gt;name, rune(v));<br />	}<br />}<br /><br />static void<br />programvessel(char *val)<br />{<br />	Vessel *v = guest-&gt;parent;<br />	if(slen(val) &lt; 1)<br />		printf("You remove the program of the %s%c.\n", v-&gt;name, rune(v));<br />	else {<br />		sstr(val, v-&gt;prog, 0, imin(slen(val), TEXTLEN - 1));<br />		printf("You programmed the %s%c.\n", v-&gt;name, rune(v));<br />	}<br />}<br /><br />static void<br />lookvessel(Parade *p)<br />{<br />	int i;<br />	if(isparadox(guest))<br />		printf("You are the %s%c.\n", guest-&gt;name, rune(guest));<br />	else<br />		printf("You are the %s%c in the %s%c.\n",<br />			guest-&gt;name,<br />			rune(guest),<br />			guest-&gt;parent-&gt;name,<br />			rune(guest-&gt;parent));<br />	if(slen(guest-&gt;parent-&gt;note) &gt; 2)<br />		printf("%s\n", guest-&gt;parent-&gt;note);<br />	for(i = 0; i &lt; p-&gt;len; ++i)<br />		if(isvisible(guest, &amp;p-&gt;vessels[i]))<br />			printf("- %s%c\n", p-&gt;vessels[i].name, rune(&amp;p-&gt;vessels[i]));<br />}<br /><br />#pragma mark - Parade<br /><br />static int usevessel(Parade *p, char *val);<br /><br />static void<br />act(Parade *p, char *cmd, char *val)<br />{<br />	/* clang-format off */<br />	switch(afnd(actions, 12, cmd)) {<br />	case 0x0: createvessel(p, val); break;<br />	case 0x1: becomevessel(p, val); break;<br />	case 0x2: entervessel(p, val); break;<br />	case 0x3: leavevessel(); break;<br />	case 0x4: takevessel(p, val); break;<br />	case 0x5: dropvessel(p, val); break;<br />	case 0x6: warpvessel(p, val); break;<br />	case 0x7: transformvessel(p, val); break;<br />	case 0x8: notevessel(val); break;<br />	case 0x9: programvessel(val); break;<br />	case 0xA: usevessel(p, val); break;<br />	case 0xB: lookvessel(p); break;<br />	default:  printf("Unknown action: %s.\n", cmd); break;<br />	}<br />	/* clang-format off */<br />}<br /><br />static Vessel *<br />spawn(Parade *p)<br />{<br />	addvessel(p, NULL, "library");<br />	addvessel(p, &amp;p-&gt;vessels[0], "ghost");<br />	return &amp;p-&gt;vessels[1];<br />}<br /><br />static int<br />parse(Parade *p, char *line, int id)<br />{<br />	int split = cpos(line, '|');<br />	int len = slen(line);<br />	Vessel *nv = &amp;p-&gt;vessels[id];<br />	if(len &lt; 22 || split &lt; 0 || line[0] == ';')<br />		return 0;<br />	nv-&gt;id = id;<br />	nv-&gt;owner = &amp;p-&gt;vessels[shex(line, 2)];<br />	nv-&gt;parent = &amp;p-&gt;vessels[shex(line + 2, 2)];<br />	strm(sstr(line, nv-&gt;name, 5, NAMELEN));<br />	if(split &gt; 23)<br />		sstr(line, nv-&gt;note, 21, split - 22);<br />	if(len - split &gt; 3)<br />		sstr(line, nv-&gt;prog, split + 2, len - split - 3);<br />	return 1;<br />}<br /><br />static int<br />save(Parade *p, char *filename)<br />{<br />	int i;<br />	FILE *f = fopen(filename, "w");<br />	for(i = 0; i &lt; p-&gt;len; ++i)<br />		fprintf(f, "%02x%02x %-15s %s | %s\n", <br />			p-&gt;vessels[i].owner-&gt;id, <br />			p-&gt;vessels[i].parent-&gt;id, <br />			p-&gt;vessels[i].name, <br />			p-&gt;vessels[i].note, <br />			p-&gt;vessels[i].prog);<br />	fclose(f);<br />	return 1;<br />}<br /><br />static int<br />load(Parade *p, char *filename)<br />{<br />	char line[BUFLEN];<br />	FILE *f = fopen(filename, "r");<br />	if(f == NULL)<br />		return 1;<br />	p-&gt;len = 0;<br />	while(fgets(line, BUFLEN, f)) {<br />		if(parse(p, line, p-&gt;len))<br />			p-&gt;len++;<br />	}<br />	return 1;<br />}<br /><br />static int<br />answer(Parade *p, char *input)<br />{<br />	int split = cpos(input, ' ');<br />	char action[NAMELEN], value[TEXTLEN];<br />	if(cpos(input, '|') &gt;= 0)<br />		return 1;<br />	if(split &gt;= 0) {<br />		sstr(input, action, 0, split);<br />		sstr(input, value, split + 1, imin(slen(input) - split, TEXTLEN - 1));<br />	} else if(slen(input) &lt; 2) {<br />		action[0] = '\0';<br />		value[0] = '\0';<br />	} else if(slen(input) &gt;= 0) {<br />		sstr(input, action, 0, imin(slen(input), NAMELEN - 1));<br />		value[0] = '\0';<br />	}<br />	if(scmp(action, "@quit"))<br />		return 0;<br />	if(scmp(action, "@save") &amp;&amp; slen(value) &gt; 3)<br />		return save(p, spor(input, ' ') + 1);<br />	if(scmp(action, "@load") &amp;&amp; slen(value) &gt; 3)<br />		return load(p, spor(input, ' ') + 1);<br />	act(p, action, value);<br />	return 1;<br />}<br /><br />static int<br />usevessel(Parade *p, char *val)<br />{<br />	Vessel *v = findvisible(p, guest, val);<br />	if(!v)<br />		printf("You do not see %s.\n", val);<br />	else if(slen(v-&gt;prog) &lt; 2)<br />		printf("You cannot use %s%c.\n", val, rune(v));<br />	else<br />		answer(p, v-&gt;prog);<br />	return 0;<br />}<br /><br />static int<br />listen(Parade *p)<br />{<br />	char input[TEXTLEN];<br />	printf("&gt; ");<br />	if(fgets(input, TEXTLEN, stdin))<br />		return answer(p, strm(input));<br />	return 0;<br />}<br /><br />int<br />main(int argc, char **argv)<br />{<br />	Parade parade;<br />	parade.len = 0;<br />	guest = spawn(&amp;parade);<br />	if(argc == 2)<br />		load(&amp;parade, argv[1]);<br />	printf("A %s%c appeared in the %s%c.\n",<br />		guest-&gt;name,<br />		rune(guest),<br />		guest-&gt;parent-&gt;name,<br />		rune(guest-&gt;parent));<br />	while(listen(&amp;parade))<br />		;<br />	return 0;<br />}<br /></pre><figcaption>&mdash; Submit an <a href='https://github.com/XXIIVV/oscean/blob/master/src/inc/text/parade.c.txt' target='_blank'>edit</a> to <a href='../src/inc/text/parade.c.txt'>parade.c.txt</a>(421 lines)</figcaption></figure><ul><li><a href='https://git.sr.ht/~rabbits/parade' target='_blank'>source</a></li></ul><p><i>incoming(2)</i>: <a href='defunct.html'>defunct</a> <a href='paradise.html'>paradise</a> </p></main><footer><a href='https://creativecommons.org/licenses/by-nc-sa/4.0'><img src='../media/icon/cc.svg' width='30'/></a><a href='http://webring.xxiivv.com/'><img src='../media/icon/webring.svg' width='30'/></a><a href='https://merveilles.town/@neauoire'><img src='../media/icon/merveilles.svg' width='30'/></a><a href='https://github.com/neauoire'><img src='../media/icon/github.png' alt='github' width='30'/></a><span><a href='devine_lu_linvega.html'>Devine Lu Linvega</a> &copy; 2021 &mdash; <a href='about.html'>BY-NC-SA 4.0</a></span></footer></body></html>